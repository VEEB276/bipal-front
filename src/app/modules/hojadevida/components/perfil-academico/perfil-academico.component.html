<div class="perfil-academico-container">
  @if (loading()) {
    <app-skeleton-banner></app-skeleton-banner>
  } @else {
  <form
    [formGroup]="perfilForm"
    (ngSubmit)="onSubmit()"
    class="perfil-academico-form"
    scrollFirstInvalid
  >
  <div formArrayName="estudios">
      @for (estudio of estudiosArray.controls; track estudio; let i = $index) {
      <mat-card class="titulo-section">
        <mat-card-header class="titulo-header">
          <mat-card-title>
            <h3 class="titulo-label">Título {{ i + 1 }}</h3>
          </mat-card-title>
          <div class="titulo-header-actions">
            <button
              type="button"
              mat-stroked-button
              color="error"
              class="eliminar-btn"
              (click)="eliminarEstudio(i)"
              [disabled]="estudiosArray.length === 1"
            >
              <mat-icon>delete</mat-icon>
              Eliminar Título {{ i + 1 }}
            </button>
          </div>
        </mat-card-header>

        <mat-card-content>
          <div [formGroupName]="i" class="titulo-form-group">
          <!-- Primera Fila: Nombre del Título -->
          <div class="form-row">
            <mat-form-field appearance="fill" class="form-field full-width">
              <mat-label>Título Académico</mat-label>
              <input
                matInput
                formControlName="nombreTitulo"
                placeholder="Ingrese el título académico"
              />
              <mat-icon matPrefix>school</mat-icon>
              <mat-error
                *ngIf="
                  getEstudioControl(i, 'nombreTitulo')?.invalid &&
                  getEstudioControl(i, 'nombreTitulo')?.touched
                "
              >
                <span
                  *ngIf="getEstudioControl(i, 'nombreTitulo')?.errors?.['required']"
                  >El título académico es requerido</span
                >
                <span
                  *ngIf="getEstudioControl(i, 'nombreTitulo')?.errors?.['maxlength']"
                  >Máximo 255 caracteres</span
                >
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Segunda Fila: Graduado, Nivel Educativo, Institución -->
          <div class="form-row">
            <mat-form-field appearance="fill" class="form-field">
              <mat-label>Graduado</mat-label>
              <mat-select formControlName="graduado">
                <mat-option *ngFor="let opcion of graduadoOptions" [value]="opcion.value">{{ opcion.label }}</mat-option>
              </mat-select>
              <mat-icon matPrefix>assignment_turned_in</mat-icon>
              <mat-error
                *ngIf="
                  getEstudioControl(i, 'graduado')?.invalid &&
                  getEstudioControl(i, 'graduado')?.touched
                "
              >
                <span
                  *ngIf="getEstudioControl(i, 'graduado')?.errors?.['required']"
                  >Seleccione si está graduado</span
                >
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill" class="form-field">
              <mat-label>Nivel Educativo</mat-label>
              <mat-select formControlName="idNivelEducativo">
                <mat-option *ngFor="let nivel of nivelesEducativos" [value]="nivel.id">{{ nivel.nombre }}</mat-option>
              </mat-select>
              <mat-icon matPrefix>grade</mat-icon>
              <mat-error
                *ngIf="
                  getEstudioControl(i, 'idNivelEducativo')?.invalid &&
                  getEstudioControl(i, 'idNivelEducativo')?.touched
                "
              >
                <span
                  *ngIf="getEstudioControl(i, 'idNivelEducativo')?.errors?.['required']"
                  >Seleccione el nivel educativo</span
                >
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill" class="form-field" [style.flex]="3">
              <mat-label
                >Institución Educativa donde Cursó sus estudios</mat-label
              >
              <input
                matInput
                formControlName="nombreInstitucion"
                placeholder="Nombre de la institución"
              />
              <mat-icon matPrefix>location_city</mat-icon>
              <mat-error
                *ngIf="
                  getEstudioControl(i, 'nombreInstitucion')?.invalid &&
                  getEstudioControl(i, 'nombreInstitucion')?.touched
                "
              >
                <span
                  *ngIf="getEstudioControl(i, 'nombreInstitucion')?.errors?.['required']"
                  >La institución educativa es requerida</span
                >
                <span
                  *ngIf="getEstudioControl(i, 'nombreInstitucion')?.errors?.['maxlength']"
                  >Máximo 255 caracteres</span
                >
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Tercera Fila: Número de Semestres Aprobados -->
          <div class="form-row">
            <div class="slider-container">
              <mat-label class="slider-label"
                >Número de Semestres Aprobados</mat-label
              >
              <div class="slider-field">
                <span class="slider-value">{{
                  getEstudioControl(i, "semestresAprobados")?.value || 0
                }}</span>
                <mat-slider
                  class="semester-slider"
                  [min]="0"
                  [max]="16"
                  [step]="1"
                >
                  <input matSliderThumb formControlName="semestresAprobados" />
                </mat-slider>
                <span class="slider-max">16</span>
              </div>
              <mat-error
                *ngIf="
                  getEstudioControl(i, 'semestresAprobados')?.invalid &&
                  getEstudioControl(i, 'semestresAprobados')?.touched
                "
              >
                <span
                  *ngIf="getEstudioControl(i, 'semestresAprobados')?.errors?.['required']"
                  >El número de semestres es requerido</span
                >
                <span
                  *ngIf="getEstudioControl(i, 'semestresAprobados')?.errors?.['min']"
                  >Mínimo 0 semestres</span
                >
                <span
                  *ngIf="getEstudioControl(i, 'semestresAprobados')?.errors?.['max']"
                  >Máximo 16 semestres</span
                >
              </mat-error>
            </div>
          </div>

          <!-- Separador entre títulos - no necesario con mat-card -->
        </div>
        </mat-card-content>
      </mat-card>
      }
    </div>

    <!-- Botón Agregar Estudios -->
    <div class="agregar-estudios-container">
      <button
        type="button"
        mat-raised-button
        color="primary"
        class="agregar-estudios-btn"
  (click)="agregarEstudio()"
      >
        <mat-icon>add</mat-icon>
  Agregar estudio
      </button>
    </div>

    <!-- Botones de Acción -->
    <div class="form-actions">
      <button
        type="submit"
        mat-flat-button
        color="primary"
      >
        <mat-icon>save</mat-icon>
        Guardar
      </button>
    </div>
  </form>
  }
</div>
