<div class="info-personal-container">
  <!-- Form Content -->
  <form [formGroup]="personaForm" class="personal-info-form">
    
    <!-- Nombres Row --------------------------------------------------------------------------------------->
    <div class="form-row">
      <mat-form-field appearance="fill" class="form-field">
        <mat-label> Primer Nombre </mat-label>
        <input matInput formControlName="primerNombre" placeholder="Primer Nombre" (input)="onNameInput('primerNombre', $event)">
        <mat-icon matPrefix> person </mat-icon>
        @if (control('primerNombre')?.invalid && control('primerNombre')?.touched) {
          <mat-error>
            @if (control('primerNombre')?.errors?.['required']) { <span>El primer nombre es requerido</span> }
            @if (control('primerNombre')?.errors?.['maxlength']) { <span>Máximo 255 caracteres</span> }
            @if (control('primerNombre')?.errors?.['pattern']) { <span>No se permiten números</span> }
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="fill" class="form-field">
        <mat-label>Segundo Nombre</mat-label>
        <input matInput formControlName="segundoNombre" placeholder="Segundo Nombre" (input)="onNameInput('segundoNombre', $event)">
        <mat-icon matPrefix>person</mat-icon>
        @if (control('segundoNombre')?.invalid && control('segundoNombre')?.touched) {
          <mat-error>
            @if (control('segundoNombre')?.errors?.['maxlength']) { <span>Máximo 255 caracteres</span> }
            @if (control('segundoNombre')?.errors?.['pattern']) { <span>No se permiten números</span> }
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="fill" class="form-field">
        <mat-label>Primer Apellido</mat-label>
        <input matInput formControlName="primerApellido" placeholder="Primer Apellido" (input)="onNameInput('primerApellido', $event)">
        <mat-icon matPrefix>person</mat-icon>
        @if (control('primerApellido')?.invalid && control('primerApellido')?.touched) {
          <mat-error>
            @if (control('primerApellido')?.errors?.['required']) { <span>El primer apellido es requerido</span> }
            @if (control('primerApellido')?.errors?.['maxlength']) { <span>Máximo 255 caracteres</span> }
            @if (control('primerApellido')?.errors?.['pattern']) { <span>No se permiten números</span> }
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="fill" class="form-field">
        <mat-label>Segundo Apellido</mat-label>
        <input matInput formControlName="segundoApellido" placeholder="Segundo Apellido" (input)="onNameInput('segundoApellido', $event)">
        <mat-icon matPrefix>person</mat-icon>
        @if (control('segundoApellido')?.invalid && control('segundoApellido')?.touched) {
          <mat-error>
            @if (control('segundoApellido')?.errors?.['maxlength']) { <span>Máximo 255 caracteres</span> }
            @if (control('segundoApellido')?.errors?.['pattern']) { <span>No se permiten números</span> }
          </mat-error>
        }
      </mat-form-field>
    </div>

    <!-- Documento Row ----------------------------------------------------------------------------------->
    <div class="form-row">
      <mat-form-field appearance="fill" class="form-field">
        <mat-label>Fecha de Nacimiento</mat-label>
        <input matInput [matDatepicker]="nacimientoPicker" formControlName="fechaNacimiento" [max]="now" placeholder="DD/MM/YYYY">
        <mat-datepicker-toggle matSuffix [for]="nacimientoPicker"></mat-datepicker-toggle>
        <mat-datepicker #nacimientoPicker></mat-datepicker>
        <mat-icon matPrefix>cake</mat-icon>
        @if (control('fechaNacimiento')?.invalid && control('fechaNacimiento')?.touched) {
          <mat-error>
            @if (control('fechaNacimiento')?.errors?.['required']) { <span>La fecha de nacimiento es requerida</span> }
          </mat-error>
        }
      </mat-form-field>
      
      <mat-form-field appearance="fill" class="form-field">
        <mat-label>Tipo de Documento</mat-label>
        <mat-select formControlName="idTipoDocumento">
          @for (td of tiposDocumento; track td.id) {
            <mat-option [value]="td.id">{{ td.nombre }}</mat-option>
          }
        </mat-select>
        <mat-icon matPrefix>credit_card</mat-icon>
        <mat-error *ngIf="control('idTipoDocumento')?.invalid && control('idTipoDocumento')?.touched">
          <span *ngIf="control('idTipoDocumento')?.errors?.['required']">Seleccione el tipo de documento</span>
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill" class="form-field">
        <mat-label>Número de Documento</mat-label>
        <input matInput formControlName="numeroDocumento" placeholder="Ejm: 1234567890">
        <mat-icon matPrefix>numbers</mat-icon>
        <mat-error *ngIf="control('numeroDocumento')?.invalid && control('numeroDocumento')?.touched">
          <span *ngIf="control('numeroDocumento')?.errors?.['required']">El número de documento es requerido</span>
          <span *ngIf="control('numeroDocumento')?.errors?.['maxlength']">Máximo 128 caracteres</span>
          <span *ngIf="control('numeroDocumento')?.errors?.['documentoExistente']">Este documento ya está registrado</span>
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill" class="form-field">
        <mat-label>Fecha de Expedición</mat-label>
        <input matInput [matDatepicker]="expedicionPicker" formControlName="fechaExpedicionDoc" [max]="now" [min]="control('fechaNacimiento')?.value || null" placeholder="DD/MM/YYYY">
        <mat-datepicker-toggle matSuffix [for]="expedicionPicker"></mat-datepicker-toggle>
        <mat-datepicker #expedicionPicker></mat-datepicker>
        @if (control('fechaExpedicionDoc')?.invalid && control('fechaExpedicionDoc')?.touched) {
          <mat-error>
            @if (control('fechaExpedicionDoc')?.errors?.['required']) { <span>La fecha de expedición del documento es requerida</span> }
            @if (control('fechaExpedicionDoc')?.errors?.['matDatepickerMin']) { <span>No puede ser anterior a la fecha de nacimiento</span> }
          </mat-error>
        }
      </mat-form-field>
    </div>

    <!-- Nacimiento y Lugar Row -->
    <div class="form-row">

      <!--lugar de nacimiento-->
      <app-autocomplete-select
        class="form-field"
        [textValue]="textLugarNacimiento"
        [control]="control('lugarNacimiento')"
        required
        [fetchFn]="fetchCiudadDepartamento"
        fieldText="nombreCompleto"
        fieldValue="departamento"
        label="Lugar de Nacimiento"
        placeholder="Ingrese y seleccione el lugar de nacimiento"
        (optionSelected)="onLugarNacimientoSelected($event)">
      </app-autocomplete-select>

      <!--lugar de residencia-->
      <app-autocomplete-select
        class="form-field"
        [textCtrl]="control('lugarResidencia')"
        required
        [fetchFn]="fetchCiudadDepartamento"
        fieldText="nombreCompleto"
        fieldValue="nombreCompleto"
        label="Lugar de Residencia"
        placeholder="Ingrese y seleccione el lugar de residencia"
        (optionSelected)="onLugarResidenciaSelected($event)">
      </app-autocomplete-select>
    </div>

    <!-- Dirección Row (más ancho) -->
    <div class="form-row">
      <mat-form-field appearance="fill" class="form-field address-field">
        <mat-label>Dirección de Residencia</mat-label>
        <input matInput formControlName="direccionResidencia" placeholder="Dirección completa">
        <mat-icon matPrefix>location_on</mat-icon>
        <mat-error *ngIf="control('direccionResidencia')?.invalid && control('direccionResidencia')?.touched">
          <span *ngIf="control('direccionResidencia')?.errors?.['required']">La dirección es requerida</span>
          <span *ngIf="control('direccionResidencia')?.errors?.['maxlength']">Máximo 255 caracteres</span>
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Contacto Row -->
    <div class="form-row">
      <mat-form-field appearance="fill" class="form-field">
        <mat-label>Número de Teléfono Celular (10 dígitos)</mat-label>
        <input matInput formControlName="telefono" placeholder="Ej: 300********" type="tel" (input)="onDigitInput('telefono', $event)">
        <mat-icon matPrefix>phone</mat-icon>
        @if (control('telefono')?.invalid && control('telefono')?.touched) {
          <mat-error>
            @if (control('telefono')?.errors?.['required']) { <span>El número de teléfono es requerido</span> }
            @if (control('telefono')?.errors?.['pattern']) { <span>Debe tener exactamente 10 dígitos</span> }
            @if (control('telefono')?.errors?.['maxlength']) { <span>Máximo 63 caracteres</span> }
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="fill" class="form-field">
        <mat-label>Correo Electrónico</mat-label>
  <input matInput formControlName="correo" placeholder="ejemplo@correo.com" type="email" (blur)="onCorreoChange()">
        <mat-icon matPrefix>email</mat-icon>
        <mat-error *ngIf="control('correo')?.invalid && control('correo')?.touched">
          <span *ngIf="control('correo')?.errors?.['required']">El correo electrónico es requerido</span>
          <span *ngIf="control('correo')?.errors?.['email']">Ingrese un correo válido</span>
          <span *ngIf="control('correo')?.errors?.['maxlength']">Máximo 127 caracteres</span>
          <span *ngIf="control('correo')?.errors?.['correoExistente']">Este correo ya está registrado</span>
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Información Adicional Row -->
    <div class="form-row">
      <mat-form-field appearance="fill" class="form-field">
        <mat-label>Sexo</mat-label>
        <mat-select formControlName="idGenero">
          @for (g of generos; track g.id) {
            <mat-option [value]="g.id">{{ g.nombre }}</mat-option>
          }
        </mat-select>
        <mat-icon matPrefix>wc</mat-icon>
        <mat-error *ngIf="control('idGenero')?.invalid && control('idGenero')?.touched">
          <span *ngIf="control('idGenero')?.errors?.['required']">Seleccione el género</span>
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill" class="form-field">
        <mat-label>Enfoque Diferencial</mat-label>
        <mat-select formControlName="idEnfoqueDiferencial">
          @for (e of enfoques; track e.id) {
            <mat-option [value]="e.id">{{ e.nombre }}</mat-option>
          }
        </mat-select>
        <mat-icon matPrefix>diversity_3</mat-icon>
        <mat-error *ngIf="control('idEnfoqueDiferencial')?.invalid && control('idEnfoqueDiferencial')?.touched">
          <span *ngIf="control('idEnfoqueDiferencial')?.errors?.['required']">Seleccione el enfoque diferencial</span>
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Contacto de Emergencia Section -->
    <div class="header-section">
      <h3>
        <mat-icon>contact_emergency</mat-icon>
        Información de Contacto
      </h3>
    </div>

    <!-- Contacto de Emergencia Row -->
    <div class="form-row">
      <mat-form-field appearance="fill" class="form-field">
        <mat-label>Nombre de Contacto</mat-label>
        <input matInput formControlName="nombreContacto" placeholder="Nombre completo del contacto" (input)="onNameInput('nombreContacto', $event)">
        <mat-icon matPrefix>person</mat-icon>
        @if (control('nombreContacto')?.invalid && control('nombreContacto')?.touched) {
          <mat-error>
            @if (control('nombreContacto')?.errors?.['required']) { <span>El nombre del contacto es requerido</span> }
            @if (control('nombreContacto')?.errors?.['maxlength']) { <span>Máximo 255 caracteres</span> }
            @if (control('nombreContacto')?.errors?.['pattern']) { <span>No se permiten números</span> }
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="fill" class="form-field">
        <mat-label>Celular de Contacto</mat-label>
        <input matInput formControlName="telefonoContacto" placeholder="Ej: 607******* / 300********" type="tel" (input)="onDigitInput('telefonoContacto', $event)">
        <mat-icon matPrefix>phone</mat-icon>
        @if (control('telefonoContacto')?.invalid && control('telefonoContacto')?.touched) {
          <mat-error>
            @if (control('telefonoContacto')?.errors?.['required']) { <span>El teléfono del contacto es requerido</span> }
            @if (control('telefonoContacto')?.errors?.['pattern']) { <span>Debe tener exactamente 10 dígitos</span> }
            @if (control('telefonoContacto')?.errors?.['maxlength']) { <span>Máximo 63 caracteres</span> }
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="fill" class="form-field">
        <mat-label>Correo de Contacto</mat-label>
  <input matInput formControlName="correoContacto" placeholder="contacto@correo.com" type="email">
        <mat-icon matPrefix>email</mat-icon>
        <mat-error *ngIf="control('correoContacto')?.invalid && control('correoContacto')?.touched">
          <span *ngIf="control('correoContacto')?.errors?.['required']">El correo del contacto es requerido</span>
          <span *ngIf="control('correoContacto')?.errors?.['email']">Ingrese un correo válido</span>
          <span *ngIf="control('correoContacto')?.errors?.['maxlength']">Máximo 127 caracteres</span>
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Action Buttons -->
    <div class="form-actions">
      <button mat-flat-button color="primary" type="button" (click)="onSubmit()">
        <mat-icon>save</mat-icon>
        {{ isEditMode ? 'Actualizar' : 'Guardar' }}
      </button>
    </div>

  </form>
</div>

