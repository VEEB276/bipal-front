<div class="experiencia-container">
  @if (loading()) {
    <app-skeleton-banner />
  } @else {
  <form [formGroup]="experienciaForm" (ngSubmit)="onSubmit()" class="experiencia-form" scrollFirstInvalid>
    <div formArrayName="experiencias">
  @for (experiencia of experienciasArray.controls; track $index; let i = $index) {
      <mat-card class="experiencia-section">
        <mat-card-header class="experiencia-header">
          <mat-card-title>
            <h3 class="experiencia-label">Experiencia {{ i + 1 }}</h3>
          </mat-card-title>
          <div class="experiencia-header-actions">
            <button
              type="button"
              mat-stroked-button
              color="error"
              class="eliminar-btn"
              (click)="eliminarExperiencia(i)"
            >
              <mat-icon>delete</mat-icon>
              Eliminar Experiencia {{ i + 1 }}
            </button>
          </div>
        </mat-card-header>

        <mat-card-content>
          <div [formGroupName]="i" class="experiencia-form-group">
            <!-- Descripción Perfil -->
            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field full-width">
                <mat-label>Descripción Perfil</mat-label>
                <textarea
                  matInput
                  formControlName="descripcionPerfil"
                  placeholder="Describe el perfil / funciones principales"
                  rows="4"
                  maxlength="800"
                ></textarea>
                <mat-icon matPrefix>description</mat-icon>
                <mat-hint align="end">{{ getExperienciaControl(i, 'descripcionPerfil')?.value?.length || 0 }}/800</mat-hint>
                @if (getExperienciaControl(i, 'descripcionPerfil')?.invalid && getExperienciaControl(i, 'descripcionPerfil')?.touched) {
                  <mat-error>
                    @if (getExperienciaControl(i, 'descripcionPerfil')?.errors?.['required']) {<span>La descripción es requerida</span>}
                    @if (getExperienciaControl(i, 'descripcionPerfil')?.errors?.['maxlength']) {<span>Máximo 800 caracteres</span>}
                  </mat-error>
                }
              </mat-form-field>
            </div>

            <!-- Tipo de Experiencia y Nombre de la Empresa -->
            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Tipo de Experiencia</mat-label>
                <mat-select formControlName="idTipoExperiencia">
                  @for (tipo of tiposExperienciaSignal(); track tipo.value) {
                    <mat-option [value]="tipo.value">{{ tipo.label }}</mat-option>
                  }
                </mat-select>
                <mat-icon matPrefix>work</mat-icon>
                @if (getExperienciaControl(i, 'idTipoExperiencia')?.invalid && getExperienciaControl(i, 'idTipoExperiencia')?.touched) {
                  <mat-error>
                    @if (getExperienciaControl(i, 'idTipoExperiencia')?.errors?.['required']) {<span>Seleccione el tipo de experiencia</span>}
                  </mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Nombre de la Empresa</mat-label>
                <input
                  matInput
                  formControlName="nombreEmpresa"
                  placeholder="Ingrese el nombre de la empresa"
                />
                <mat-icon matPrefix>business</mat-icon>
                @if (getExperienciaControl(i, 'nombreEmpresa')?.invalid && getExperienciaControl(i, 'nombreEmpresa')?.touched) {
                  <mat-error>
                    @if (getExperienciaControl(i, 'nombreEmpresa')?.errors?.['required']) {<span>El nombre de la empresa es requerido</span>}
                    @if (getExperienciaControl(i, 'nombreEmpresa')?.errors?.['maxlength']) {<span>Máximo 255 caracteres</span>}
                  </mat-error>
                }
              </mat-form-field>
            </div>

            <!-- Nombre del Cargo y Dependencia -->
            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Nombre del Cargo</mat-label>
                <input
                  matInput
                  formControlName="nombreCargo"
                  placeholder="Ingrese el nombre del cargo"
                />
                <mat-icon matPrefix>person_outline</mat-icon>
                @if (getExperienciaControl(i, 'nombreCargo')?.invalid && getExperienciaControl(i, 'nombreCargo')?.touched) {
                  <mat-error>
                    @if (getExperienciaControl(i, 'nombreCargo')?.errors?.['required']) {<span>El nombre del cargo es requerido</span>}
                    @if (getExperienciaControl(i, 'nombreCargo')?.errors?.['maxlength']) {<span>Máximo 255 caracteres</span>}
                  </mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Dependencia donde Desempeñó el Cargo</mat-label>
                <input
                  matInput
                  formControlName="dependenciaCargo"
                  placeholder="Ingrese la dependencia"
                />
                <mat-icon matPrefix>account_balance</mat-icon>
                @if (getExperienciaControl(i, 'dependenciaCargo')?.invalid && getExperienciaControl(i, 'dependenciaCargo')?.touched) {
                  <mat-error>
                    @if (getExperienciaControl(i, 'dependenciaCargo')?.errors?.['required']) {<span>La dependencia es requerida</span>}
                    @if (getExperienciaControl(i, 'dependenciaCargo')?.errors?.['maxlength']) {<span>Máximo 255 caracteres</span>}
                  </mat-error>
                }
              </mat-form-field>
            </div>

            <!-- Trabajo Actual, Fecha de Inicio y Fecha de Retiro -->
            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>¿Es su Trabajo Actual?</mat-label>
                <mat-select 
                  formControlName="esTrabajoActual"
                  (selectionChange)="onTrabajoActualChange(i)"
                >
                  <mat-option
                    *ngFor="let opcion of trabajoActualOptions"
                    [value]="opcion.value"
                  >
                    {{ opcion.label }}
                  </mat-option>
                </mat-select>
                <mat-icon matPrefix>check_circle</mat-icon>
                @if (getExperienciaControl(i, 'esTrabajoActual')?.invalid && getExperienciaControl(i, 'esTrabajoActual')?.touched) {
                  <mat-error>
                    @if (getExperienciaControl(i, 'esTrabajoActual')?.errors?.['required']) {<span>Debe indicar si es su trabajo actual</span>}
                  </mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Fecha de Inicio del Cargo</mat-label>
                <input
                  matInput
                  [matDatepicker]="fechaInicioPicker"
                  formControlName="fechaDesde"
                  placeholder="DD/MM/AAAA"
                />
                <mat-datepicker-toggle
                  matIconSuffix
                  [for]="fechaInicioPicker"
                ></mat-datepicker-toggle>
                <mat-datepicker #fechaInicioPicker></mat-datepicker>
                <mat-icon matPrefix>event</mat-icon>
                @if (getExperienciaControl(i, 'fechaDesde')?.invalid && getExperienciaControl(i, 'fechaDesde')?.touched) {
                  <mat-error>
                    @if (getExperienciaControl(i, 'fechaDesde')?.errors?.['required']) {<span>La fecha de inicio es requerida</span>}
                  </mat-error>
                }
              </mat-form-field>

              @if (!isRetiroDisabled(i)) {
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Fecha de Retiro del Cargo</mat-label>
                <input
                  matInput
                  [matDatepicker]="fechaRetiroPicker"
                  formControlName="fechaHasta"
                  placeholder="DD/MM/AAAA"
                  [min]="getExperienciaControl(i,'fechaDesde')?.value"
                />
                <mat-datepicker-toggle matIconSuffix [for]="fechaRetiroPicker"></mat-datepicker-toggle>
                <mat-datepicker #fechaRetiroPicker></mat-datepicker>
                <mat-icon matPrefix>event_busy</mat-icon>
                @if(getExperienciaControl(i,'fechaHasta')?.errors?.matDatepickerMin){
                <mat-error>
                  La fecha de retiro debe ser mayor que la fecha de inicio.
                </mat-error>
                }
              </mat-form-field>
              }
            </div>
          </div>
        </mat-card-content>
      </mat-card>
      }
    </div>

    <!-- Botón Agregar Experiencia -->
    <div class="agregar-experiencia-container">
      <button
        type="button"
        mat-raised-button
        color="primary"
        class="agregar-experiencia-btn"
        (click)="agregarExperiencia()"
      >
        <mat-icon>add</mat-icon>
        Agregar Experiencia
      </button>
    </div>

    <!-- Botones de Acción -->
    <div class="form-actions">
      <button
        type="submit"
        mat-flat-button
        color="primary"
      >
        <mat-icon>save</mat-icon>
        Guardar
      </button>
    </div>
  </form>
  }
</div>
